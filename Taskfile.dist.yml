version: '3.0'

vars:
  ALVAO_VERSION: '25.3.2'
  OWNER: Ash258
  NUGET_NAME: "{{.OWNER}}.Alvao.Mock.API"
  NUGET_API_KEY_GH: "{{.NUGET_API_KEY_GH}}"
  NUGET_API_KEY: "{{.NUGET_API_KEY}}"

tasks:
  build:
    cmd: dotnet run -- {{.CLI_ARGS}}
  run:with-build:
    cmds:
    - task: build
    - task: library:build
  html-cache:clean:
    cmd: rm -rf html/**
  library:clean:
    dir: Alvao
    vars:
      folders: [ "API", "Context" ]
    ignore_error: true
    cmd:
      for:
        var: folders
      cmd: rm -rf {{ .ITEM }}/**
  library:format:
    cmd: dotnet format Alvao/
  library:build:
    dir: Alvao
    cmd: dotnet build .
  library:publish:
    dir: Alvao
    cmds:
    - dotnet nuget push bin/Release/{{.NUGET_NAME}}.{{.ALVAO_VERSION}}.nupkg --api-key {{.NUGET_API_KEY_GH}} --source https://nuget.pkg.github.com/{{.OWNER}}/index.json
    - dotnet nuget push bin/Release/{{.NUGET_NAME}}.{{.ALVAO_VERSION}}.nupkg --api-key {{.NUGET_API_KEY}} --source https://api.nuget.org/v3/index.json
  library:pack:
    dir: Alvao
    cmds:
    - sed -i.backup -E 's/Version>[0-9.\-]+</Version>{{.ALVAO_VERSION}}</' Alvao.csproj
    - dotnet pack --configuration Release
  test:
    cmd: dotnet run -- test
  tidy:
    ignore_error: true
    aliases:
    - format
    generates:
    - html/*.html
    sources:
    - html/*.html
    cmd: tidy -config .tidyrc -f errors.txt -m html/*.htm*
  dotnet:run:
    cmd: dotnet run {{ .CLI_ARGS }}
  format:
    sources:
    - Program.cs
    - src/**
    - .editorconfig
    cmd: dotnet format
  clean:
    cmd: rm -rf Alvao/ Examples/
  restore:
    cmd: git checkout -- Examples/
  run:
    aliases:
    - default
    - r
    cmds:
    - task: format
    - task: build
    - task: tidy
    - task: library:build
    - task: library:format
    - task: library:build
    - task: library:pack
  run:clean:
    aliases:
    - default
    - r:c
    cmds:
    - task: library:clean
    - task: run
  run:clean:html:
    aliases:
    - r:c:h
    cmds:
    - task: html-cache:clean
    - task: run:clean
